# Setting up dev env and running a contract

### Environment

### Dependencies

* npm
  * [solc](https://www.npmjs.com/package/solc): js binding for Solidity compiler
  * (optional) [truffle](https://www.npmjs.com/package/truffle): dev environment, test framework, deployment tool
* Docker
* [go-ethereum](https://github.com/ethereum/go-ethereum/wiki/Installation-Instructions-for-Mac#installing-with-homebrew)

### Workflow

* Set up private network
```
docker-compose up
```
This sets up 1 bootnode, 3 miners running geth and 1 monitor.

* Compile contract
```
solcjs --abi voting.sol
solcjs --bin voting.sol
```
* Deploy contract (from miner-2)
```
geth attach http://localhost:8546
```
In geth console:
```js
var contract = web3.eth.contract(/* contract_abi */);

var deploy = {from: eth.coinbase, data: /* contract_bytecode */, gas: 2000000};

var instance = contract.new(/* ctor args */, deploy);

// Error: invalid address
// web3.eth.defaultAccount = web3.eth.accounts[0]

var ins = contract.at(instance.address);

// interact with the contract
ins.voteForCandidate(/* candidate */, {from: web3.eth.accounts[0]});

// check wei balance
web3.fromWei(eth.getBalance(eth.coinbase), "ether");

```
* To retrieve a contract given a block number
```js
web3.eth.getBlock(3); // copy transaction hash out

web3.eth.getTransactionReceipt(/* transaction hash */); // copy contractAddress out

// need contract abi to retrieve an instance we can interact with
var contract = web3.eth.contract(/* contract_abi */);

var ins = contract.at(instance.address);
```

* customizing genesis block
```
puppeth
```

### What to expect

About every 15s a new block is mined.
Network dashboard at http://localhost:3000.

### Working with Docker

* List all containers, stop and remove
```
docker ps -aq
docker stop $(docker ps -aq)
docker rm $(docker ps -aq)
```

* Remove all images
```
docker rmi $(docker images -q)
```

* Update docker-compose
```
docker-compose up -d --no-deps --build <container name>
```

* Exec into a running container
```
docker exec -it <container name> bash
```

### Issues

```
Q: Clique: discarded bad propagated block#1 when syncing
A: seems a known issue (https://github.com/ethereum/go-ethereum/issues/14945), PoW (default config) worked fine. Also remember to alloc ethers to new accounts in genesis.

Q: Clique: block sealing failed err=unauthorized?
A: https://github.com/ethereum/go-ethereum/issues/17443. Make sure you have adequate amount of signers, and that their configuration in genesis block is conventional (e.g., extraData ordering). Could use puppeth to generate genesis block.

Q: deploy contract in geth console but an address always says undefined
A: make sure the chain is working as intended (miner is running, and one new block generated and sync'ed every x seconds), make sure the account from which the contract is deployed is unlocked. Double check your genesis block to see if the accounts are prefunded, and in Clique's case, if enough number of peers are allowed as signers.

Q: genesis block generated by puppeth complains about missing 'gasLimit'
A: https://github.com/ethereum/go-ethereum/issues/16317

Q: error "invalid address" when performing functions on smart contracts (with address parameters)?
A: make sure this is set. web3.eth.defaultAccount = eth.accounts[0]
```

### Credit

* Tim ZÃ¶ller, [setting up a private network](https://medium.com/@javahippie/building-a-local-ethereum-network-with-docker-and-geth-5b9326b85f37)
* Mahesh Murthy, [voting contract](https://medium.com/@mvmurthy/full-stack-hello-world-voting-ethereum-dapp-tutorial-part-1-40d2d0d807c2)
* Mercury Protocol, [deploying a contract](https://medium.com/mercuryprotocol/dev-highlights-of-this-week-cb33e58c745f)